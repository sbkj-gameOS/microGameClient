{"version":3,"sources":["..\\..\\..\\..\\..\\..\\..\\assets\\module\\login\\weChat\\js/assets\\module\\login\\weChat\\js\\common.js"],"names":["WJFCommon","require","tongyi","a","cc","Class","extends","properties","agree","default","type","Node","successBtn","loginLogoNode","WZLogo","SpriteFrame","CCLogo","JXLogo","onLoad","WXorBlow","sprite","getComponent","Sprite","weijifen","GameBase","gameModel","spriteFrame","xySuccess","localStorage","get","tourist","active","login","http","httpGet","authorization","roomSuccess","roomError","init","result","object","data","JSON","parse","room","getGame","alert","loadding","xhr","guestSucess","error","token","id","click","toggle","isChecked","msg","closeloadding","closealert","reset","scene","wxlogin","put","getUrlParam","code","values","i","split","wxseccess","paystatus","sucess","success","rooms","httpPost","JRsucess","JRerror","connect","playway","director","preloadScene","loadScene","name","url","window","location","search","replace","reg","RegExp","r","substr","match","unescape"],"mappings":"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","file":"common.js","sourceRoot":"..\\..\\..\\..\\..\\..\\..\\assets\\module\\login\\weChat\\js","sourcesContent":["var WJFCommon = require(\"WJFCommon\");\r\nvar tongyi = true;\r\nvar a = 1;\r\ncc.Class({\r\n    extends: WJFCommon,\r\n    properties: {\r\n        agree:{\r\n            default:null,\r\n            type: cc.Node\r\n        },\r\n        successBtn:{\r\n            default:null,\r\n            type: cc.Node\r\n        },\r\n        loginLogoNode:{\r\n            default:null,\r\n            type:cc.Node\r\n        },\r\n        WZLogo:{\r\n            default:null,\r\n            type:cc.SpriteFrame\r\n        },\r\n        CCLogo:{\r\n            default:null,\r\n            type:cc.SpriteFrame\r\n        },\r\n        JXLogo:cc.SpriteFrame,\r\n    },\r\n    // 首次加载页面方法\r\n    onLoad: function () {\r\n        let WXorBlow;\r\n        tongyi = true;\r\n        var sprite = this.loginLogoNode.getComponent(cc.Sprite);\r\n        if(cc.weijifen.GameBase.gameModel =='wz'){\r\n            sprite.spriteFrame = this.WZLogo;\r\n        }else if(cc.weijifen.GameBase.gameModel == 'ch'){\r\n            sprite.spriteFrame = this.CCLogo;\r\n        }else if(cc.weijifen.GameBase.gameModel == 'jx'){\r\n            sprite.spriteFrame = this.JXLogo;\r\n        }\r\n        /**\r\n         * 游客登录，无需弹出注册对话框，先从本地获取是否有过期的对话数据，如果有过期的对话数据，则使用过期的对话数据续期\r\n         * 如果没有对话数据，则重新使用游客注册接口\r\n         */\r\n        var xySuccess = cc.weijifen.localStorage.get(\"xySuccess\");\r\n        this.tourist();        \r\n        if(xySuccess == 1){\r\n            this.successBtn.active = false;\r\n            this.login();\r\n        }       \r\n        WXorBlow = require('ShareWx');  \r\n        cc.weijifen.WXorBlow = new WXorBlow();\r\n        cc.weijifen.http.httpGet('/api/room/reConnection?token='+cc.weijifen.authorization,this.roomSuccess,this.roomError,this);        \r\n        cc.weijifen.WXorBlow.init();   \r\n        //请求获取当前用户是否已经参加了房间   \r\n        \r\n    },\r\n    //重连后进入重新获得的一些数据\r\n    roomSuccess: function(result,object){\r\n        let data = JSON.parse(result);\r\n        if(result.room){\r\n            object.getGame(data);\r\n        }else{\r\n            cc.weijifen.room = null;\r\n        }   \r\n    },\r\n    roomError: function(object){\r\n        object.alert(\"网络异常\");\r\n    },\r\n    //游客登录方法\r\n    tourist: function(){\r\n        if(tongyi){\r\n            this.loadding();\r\n            if(cc.weijifen.localStorage.get(\"userinfo\") == null){\r\n                //发送游客注册请求\r\n                var xhr = cc.weijifen.http.httpGet(\"/api/guest\", this.guestSucess , this.error , this);\r\n            }else{\r\n                //通过ID获取 玩家信息\r\n                var data = JSON.parse(cc.weijifen.localStorage.get(\"userinfo\")) ;\r\n                if(data.token != null){     //获取用户登录信息\r\n                    var xhr = cc.weijifen.http.httpGet(\"/api/guest?token=\"+data.token.id, this.guestSucess , this.error , this);\r\n                }\r\n            }\r\n        }else{\r\n            this.alert('请同意用户使用协议');\r\n        }     \r\n    },\r\n    //同意协议内容\r\n    click: function(toggle){\r\n        tongyi = toggle.isChecked;\r\n    },\r\n    guestSucess:function(result , object){\r\n        var data = JSON.parse(result) ;\r\n        if(data.error){\r\n            object.alert(data.msg);\r\n            object.closeloadding();\r\n        }else if(data!=null && data.token!=null && data.data!=null){\r\n            object.closealert();\r\n            //放在全局变量\r\n            object.reset(data , result);\r\n            //预加载场景\r\n           object.scene(\"gameMain\" , object) ;        \r\n        }\r\n    },\r\n    wxlogin: function(){\r\n        if(tongyi){\r\n            cc.weijifen.localStorage.put(\"xySuccess\",\"1\");\r\n            this.login();    \r\n        }else{\r\n            this.alert('请同意用户使用协议');\r\n        }\r\n    },\r\n    login:function(){\r\n        this.loadding();\r\n        if(this.getUrlParam(\"invitationcode\")){\r\n            var code = values[i].split('=')[1];\r\n            cc.weijifen.http.httpGet('/wxController/getLoginCode?invitationcode='+this.getUrlParam(\"invitationcode\"),this.wxseccess,this.error,this);\r\n        }\r\n        //判断是否有充值\r\n        if (this.getUrlParam('status')){\r\n            cc.weijifen.paystatus = this.getUrlParam(\"invitationcode\");\r\n        }\r\n        //直接点击链接登陆\r\n        if (this.getUrlParam('userId')){\r\n            cc.weijifen.http.httpGet('/wxController/getWxUserToken?userId='+this.getUrlParam('userId'),this.sucess,this.error,this);\r\n        }\r\n    },\r\n   sucess:function(result,object){\r\n       var data = JSON.parse(result) ;\r\n       if(data.error){\r\n            object.alert(data.msg);\r\n            object.closeloadding();\r\n       }else if(data != null && data.success == true && data.token!=null){\r\n             object.reset(data,result);  \r\n            //房间号参数不为空    直接进入房间\r\n            if (object.getUrlParam('roomNum') != 'null' && object.getUrlParam('roomNum') != null){\r\n                let rooms = object.getUrlParam('roomNum');\r\n                if(typeof(rooms) =='number'&&((cc.weijifen.room!=null&&cc.weijifen.room == rooms)||cc.weijifen.room==null)){\r\n                    var room={};\r\n                    room.token = cc.weijifen.authorization;\r\n                    room.room = rooms;\r\n                }\r\n                cc.weijifen.http.httpPost('/api/room/query',room,object.JRsucess,object.JRerror,object);\r\n            }else{\r\n                object.closealert();\r\n                object.connect();\r\n                object.scene(\"gameMain\" , object) ;\r\n            }\r\n       }\r\n   },\r\n   error:function(object){\r\n       object.closeloadding();\r\n       object.alert(\"网络异常，服务访问失败\");\r\n   },\r\n   JRsucess: function(result,object){\r\n        let data = JSON.parse(result);\r\n        let room = object.getUrlParam('roomNum');\r\n        if(data.error){\r\n            object.alert(data.msg);\r\n            object.closeloadding();\r\n        }else{\r\n            object.closealert();\r\n            if(data.playway&&data.room){\r\n                object.getGame(data,room);\r\n                cc.director.preloadScene('majiang',function(){\r\n                    cc.director.loadScene('majiang');\r\n                });\r\n            }else{\r\n                object.connect();\r\n                object.scene(\"gameMain\" , object) ;  \r\n            } \r\n        }  \r\n    },\r\n    JRerror: function(object){\r\n        object.closeloadding();\r\n        object.alert('房间加入失败');\r\n    },\r\n   //获取url中的参数\r\n   getUrlParam:function(name) {\r\n       var url = window.location.search.replace(\"amp;\",\"\");\r\n       var reg = new RegExp(\"(^|&)\" + name + \"=([^&]*)(&|$)\"); //构造一个含有目标参数的正则表达式对象\r\n       var r = url.substr(1).match(reg); //匹配目标参数\r\n       if (r != null) return unescape(r[2]); return null; //返回参数值\r\n    },\r\n});\r\n"]}